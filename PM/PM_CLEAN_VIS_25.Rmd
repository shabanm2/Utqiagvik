---
title: "PM_CLEAN_VIS_25"
author: "Mirella Shaban"
date: "2025-06-18"
output: html_document
---
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(lubridate)
library(tidyr)
library(gridExtra)
library(forcats)
library(splitstackshape) # basically like text to columns
library(readr)
library(RColorBrewer)
library(caret)
```

```{r}
Sum_PM_25_61_617 <- read_csv("~/Desktop/PM_VIS_TEMP/Hourly_June1_17.csv")
Sum_PM_25_618_712 <- read_csv("~/Desktop/PM_VIS_TEMP/SUM_PM_618_712.csv")
Sum_PM_25_71_730 <- read_csv("~/Desktop/PM_VIS_TEMP/July1to30.csv")
Sum_PM_25_730_91 <- read_csv("~/Desktop/PM_VIS_TEMP/july30tosep1.csv")

Sum_PM_25_61_617$Time <- as.POSIXct(Sum_PM_25_61_617$Time, format = "%m-%d-%Y %H:%M") #already in AKST from Datacake report
Sum_PM_25_618_712$Time <- as.POSIXct(Sum_PM_25_618_712$Time, format = "%m-%d-%Y %H:%M")
Sum_PM_25_71_730$Time <- as.POSIXct(Sum_PM_25_71_730$Time, format = "%m-%d-%Y %H:%M")
Sum_PM_25_730_91$Time <- as.POSIXct(Sum_PM_25_71_91$Time, format = "%m-%d-%Y %H:%M")
```

```{r}
data_long <- Sum_PM_25_61_617 %>%
  pivot_longer(
    cols = -Time,                  # Target all columns except 'Time' for pivoting
    names_to = c("node_number", "data_type"), # Create two new columns from old column names
    names_sep = " / ",             # Split the old column names by " / "
    values_to = "value"            # Name the column where the actual measurements will go
  )

data_long_1 <- Sum_PM_25_618_712 %>%
  pivot_longer(
    cols = -Time,                  # Target all columns except 'Time' for pivoting
    names_to = c("node_number", "data_type"), # Create two new columns from old column names
    names_sep = " / ",             # Split the old column names by " / "
    values_to = "value"            # Name the column where the actual measurements will go
  )

data_long_2 <- Sum_PM_25_71_730 %>%
  pivot_longer(
    cols = -Time,                  # Target all columns except 'Time' for pivoting
    names_to = c("node_number", "data_type"), # Create two new columns from old column names
    names_sep = " / ",             # Split the old column names by " / "
    values_to = "value"            # Name the column where the actual measurements will go
  )

data_long_3 <- Sum_PM_25_730_91 %>%
  pivot_longer(
    cols = -Time,                  # Target all columns except 'Time' for pivoting
    names_to = c("node_number", "data_type"), # Create two new columns from old column names
    names_sep = " / ",             # Split the old column names by " / "
    values_to = "value"            # Name the column where the actual measurements will go
  )

Sum_PM_25 <- rbind(data_long, data_long_1, data_long_2, data_long_3)

df_unique <- unique(Sum_PM_25)

#write.csv(df_unique, "~/Desktop/PM_VIS_TEMP/fullsummer25_PM_AND_Temp_dataset.csv")

```

```{r fig, fig.height = 80, fig.width = 28}
 xy <- df_unique %>% filter(data_type != "Temperature" & value != "999") 
  
  

  ggplot(xy, aes(x = Time, y = value, color = data_type)) +
  geom_line() +
  guides(color = guide_legend(override.aes = list(size=0))) +
  theme(legend.title = element_text(size = 40, face = "bold"),legend.text = element_text(size = 30)) +
  facet_wrap(~ node_number, scales = "free", ncol = 1) +  # Facet by source, scales = "free" allows each part of the facet to have its own x and y axis based on that particular locations scale/range
  labs(title = "PM Levels Over Time, 6/1/25-9/1/25",
       x = "Time",
       y = "Pollutant Level",
       color = "Pollutant") +
    scale_x_datetime(date_breaks = "1 week", date_labels = "%m-%d") +  # Set breaks every 1 week
   # scale_y_continuous(breaks = seq(0, max(node03$value, na.rm = TRUE), by = 20)) +  # Tick marks every X units
  theme_bw() +
  theme(axis.text.y =element_text(size = 20) ,
        axis.text.x=element_text(angle = 45, hjust = 1.0, size = 18), 
        strip.text= element_text(size=35, face = "bold"),
        axis.line = element_line(colour = "black", size =0.5, linetype = "solid")) +
  theme(plot.title = element_text(hjust = 0.5, size = 30),
        axis.title.x = element_text(size = 25),
        axis.title.y = element_text(size = 25)) 

```


```{r}
library(dplyr)

# ---------------------------------------------------------------
# 1.  WHO 24-hour thresholds
# ---------------------------------------------------------------
limits <- tibble(
  data_type = c("PM2_5", "PM10_0"),
  threshold = c(15,        45)          # WHO-2021 24-h limits
)

# ---------------------------------------------------------------
# 2.  Rows that exceed the appropriate limit
# ---------------------------------------------------------------
exceed_tbl <- xy %>%                        # xy is your original tibble
  left_join(limits, by = "data_type") %>%   # add the proper threshold
  filter(value > threshold) %>%             # keep only exceedances
  transmute(                                # keep / rename columns
    node       = node_number,
    data_type,                              # keep the PM species
    value,
    date       = Time
  )

# ---------------------------------------------------------------
# 3.  Result
# ---------------------------------------------------------------
exceed_tbl
```

Number of times each node exceeded the exceedance values listed above
```{r}
# Using table() function
node_counts <- as.data.frame(table(exceed_tbl$node))
names(node_counts) <- c("node_number", "count")

node_counts
```




#overall number of times threshold for each pollutant type was exceeded
```{r}
# WHO-2021 24-h thresholds (2.5 = 15 , 10 = 45)
# NAAQS-2024 24-h thresholds (2.5 = 35, 10= 150)
limits <- tibble(
  data_type = c("PM2_5", "PM10_0"),
  threshold = c(35,        150)     # µg/m³
)

exceed_totals <- xy %>%
  left_join(limits, by = "data_type") %>%   # add the limit
  filter(value >= threshold) %>%            # keep readings ≥ limit
  dplyr::summarise(                         # be explicit → dplyr::
    n_exceedances = dplyr::n(),             # count rows in each group
    .by = data_type                         # new dplyr 1.1+ syntax
  )

exceed_totals
```





```{r}

# Base R approach with aggregate
result <- aggregate(value ~ node_number + data_type, 
                    data = xy, 
                    FUN = mean)

# Then reshape to wide format
result_wide <- reshape(result, 
                       idvar = "node_number", 
                       timevar = "data_type", 
                       direction = "wide")

# Clean up column names
names(result_wide) <- gsub("value.", "", names(result_wide))

result_wide
```








#specific selections of nodes for Todd & Bryan

```{r fig, fig.height = 20, fig.width = 28}
#figures of just todds sensors

xy <- xy %>% filter(node_number == "node-06" | node_number == "node-08") 
  
  

  ggplot(xy, aes(x = Time, y = value, color = data_type)) +
  geom_line() +
  guides(color = guide_legend(override.aes = list(size=0))) +
  theme(legend.title = element_text(size = 40, face = "bold"),legend.text = element_text(size = 30)) +
  facet_wrap(~ node_number, scales = "free", ncol = 1) +  # Facet by source, scales = "free" allows each part of the facet to have its own x and y axis based on that particular locations scale/range
  labs(title = "PM Levels Over Time, 6/1/25-9/1/25",
       x = "Time",
       y = "Pollutant Level",
       color = "Pollutant") +
    scale_x_datetime(date_breaks = "1 week", date_labels = "%m-%d") +  # Set breaks every 1 week
    # scale_y_continuous(breaks = seq(0, max(node03$value, na.rm = TRUE), by = 20)) +  # Tick marks every X units
  theme_bw() +
  theme(axis.text.y =element_text(size = 20) ,
        axis.text.x=element_text(angle = 45, hjust = 1.0, size = 18), 
        strip.text= element_text(size=35, face = "bold"),
        axis.line = element_line(colour = "black", size =0.5, linetype = "solid")) +
  theme(plot.title = element_text(hjust = 0.5, size = 30),
        axis.title.x = element_text(size = 25),
        axis.title.y = element_text(size = 25)) 
```
```{r fig, fig.height = 20, fig.width = 28}
#Bryan's only
xy <- data_long %>% filter(data_type != "Temperature" & value != "999")
xy <- xy %>% filter(node_number == "node-04") 
  
  

  ggplot(xy, aes(x = Time, y = value, color = data_type)) +
  geom_line() +
  guides(color = guide_legend(override.aes = list(size=0))) +
  theme(legend.title = element_text(size = 40, face = "bold"),legend.text = element_text(size = 30)) +
  facet_wrap(~ node_number, scales = "free", ncol = 1) +  # Facet by source, scales = "free" allows each part of the facet to have its own x and y axis based on that particular locations scale/range
  labs(title = "PM Levels Over Time, 6/1/25-6/17/25",
       x = "Time",
       y = "Pollutant Level",
       color = "Pollutant") +
    scale_x_datetime(date_breaks = "1 hours", date_labels = "%m-%d") +  # Set breaks every 6 hours
   # scale_y_continuous(breaks = seq(0, max(node03$value, na.rm = TRUE), by = 20)) +  # Tick marks every X units
  theme_bw() +
  theme(axis.text.y =element_text(size = 20) ,
        axis.text.x=element_text(angle = 45, hjust = 1.0, size = 18), 
        strip.text= element_text(size=35, face = "bold"),
        axis.line = element_line(colour = "black", size =0.5, linetype = "solid")) +
  theme(plot.title = element_text(hjust = 0.5, size = 30),
        axis.title.x = element_text(size = 25),
        axis.title.y = element_text(size = 25)) 
  
```

```{r}
#chunk to pick out dates, sensor names for PM2.5 & PM 10 when above threshold
```

